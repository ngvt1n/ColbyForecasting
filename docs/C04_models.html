<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Models – Colby Forecasting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./C05_prediction.html" rel="next">
<link href="./C03_covariates.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./C04_models.html">Models</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Colby Forecasting</a> 
        <div class="sidebar-tools-main">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/BigelowLab/ColbyForecasting">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/BigelowLab/ColbyForecasting/issues">
            Report a bug or ask a question
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://github.com/BigelowLab/ColbyForecasting/wiki">
            Wiki
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C00_coding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coding</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C01_observations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Observations</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C02_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Background</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C03_covariates.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Covariates</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C04_models.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./C05_prediction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prediction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup"><span class="header-section-number">1</span> Setup</a></li>
  <li><a href="#load-data---choose-a-month-and-sampling-approach" id="toc-load-data---choose-a-month-and-sampling-approach" class="nav-link" data-scroll-target="#load-data---choose-a-month-and-sampling-approach"><span class="header-section-number">2</span> Load data - choose a month and sampling approach</a></li>
  <li><a href="#splitting-the-data-into-groups" id="toc-splitting-the-data-into-groups" class="nav-link" data-scroll-target="#splitting-the-data-into-groups"><span class="header-section-number">3</span> Splitting the data into groups</a>
  <ul class="collapse">
  <li><a href="#initial-split-into-training-and-testing-groups" id="toc-initial-split-into-training-and-testing-groups" class="nav-link" data-scroll-target="#initial-split-into-training-and-testing-groups"><span class="header-section-number">3.1</span> Initial split into training and testing groups</a></li>
  <li><a href="#split-the-training-group-into-regional-folds" id="toc-split-the-training-group-into-regional-folds" class="nav-link" data-scroll-target="#split-the-training-group-into-regional-folds"><span class="header-section-number">3.2</span> Split the training group into regional folds</a></li>
  </ul></li>
  <li><a href="#build-a-recipe" id="toc-build-a-recipe" class="nav-link" data-scroll-target="#build-a-recipe"><span class="header-section-number">4</span> Build a recipe</a></li>
  <li><a href="#create-a-workflow" id="toc-create-a-workflow" class="nav-link" data-scroll-target="#create-a-workflow"><span class="header-section-number">5</span> Create a workflow</a>
  <ul class="collapse">
  <li><a href="#chosing-metrics-for-measuring-how-well-the-models-do" id="toc-chosing-metrics-for-measuring-how-well-the-models-do" class="nav-link" data-scroll-target="#chosing-metrics-for-measuring-how-well-the-models-do"><span class="header-section-number">5.1</span> Chosing metrics for measuring how well the models do</a></li>
  </ul></li>
  <li><a href="#fit-the-models-to-the-various-recipes" id="toc-fit-the-models-to-the-various-recipes" class="nav-link" data-scroll-target="#fit-the-models-to-the-various-recipes"><span class="header-section-number">6</span> Fit the models to the various recipes</a>
  <ul class="collapse">
  <li><a href="#hyperparameters---say-what" id="toc-hyperparameters---say-what" class="nav-link" data-scroll-target="#hyperparameters---say-what"><span class="header-section-number">6.1</span> Hyperparameters? - say what?</a>
  <ul class="collapse">
  <li><a href="#iterate-to-find-various-hyperparameter-sets" id="toc-iterate-to-find-various-hyperparameter-sets" class="nav-link" data-scroll-target="#iterate-to-find-various-hyperparameter-sets"><span class="header-section-number">6.1.1</span> Iterate to find various hyperparameter sets</a></li>
  <li><a href="#choose-the-best-set-of-hyperparameters-for-each-model" id="toc-choose-the-best-set-of-hyperparameters-for-each-model" class="nav-link" data-scroll-target="#choose-the-best-set-of-hyperparameters-for-each-model"><span class="header-section-number">6.1.2</span> Choose the best set of hyperparameters for each model</a></li>
  </ul></li>
  <li><a href="#exploring-the-collection-of-model-fit-results" id="toc-exploring-the-collection-of-model-fit-results" class="nav-link" data-scroll-target="#exploring-the-collection-of-model-fit-results"><span class="header-section-number">6.2</span> Exploring the collection of model fit results</a>
  <ul class="collapse">
  <li><a href="#a-table-of-metrics" id="toc-a-table-of-metrics" class="nav-link" data-scroll-target="#a-table-of-metrics"><span class="header-section-number">6.2.1</span> A table of metrics</a></li>
  <li><a href="#confusion-matrices-and-accuracy" id="toc-confusion-matrices-and-accuracy" class="nav-link" data-scroll-target="#confusion-matrices-and-accuracy"><span class="header-section-number">6.2.2</span> Confusion matrices and accuracy</a></li>
  <li><a href="#rocauc" id="toc-rocauc" class="nav-link" data-scroll-target="#rocauc"><span class="header-section-number">6.2.3</span> ROC/AUC</a></li>
  <li><a href="#variable-importance" id="toc-variable-importance" class="nav-link" data-scroll-target="#variable-importance"><span class="header-section-number">6.2.4</span> Variable importance</a></li>
  </ul></li>
  <li><a href="#exploring-a-single-model-fit-result" id="toc-exploring-a-single-model-fit-result" class="nav-link" data-scroll-target="#exploring-a-single-model-fit-result"><span class="header-section-number">6.3</span> Exploring a single model fit result</a>
  <ul class="collapse">
  <li><a href="#partial-dependence-plot" id="toc-partial-dependence-plot" class="nav-link" data-scroll-target="#partial-dependence-plot"><span class="header-section-number">6.3.1</span> Partial dependence plot</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#recap" id="toc-recap" class="nav-link" data-scroll-target="#recap"><span class="header-section-number">7</span> Recap</a></li>
  <li><a href="#coding-assignment" id="toc-coding-assignment" class="nav-link" data-scroll-target="#coding-assignment"><span class="header-section-number">8</span> Coding Assignment</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Models</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<dl>
<dt>All models are wrong, but some are useful.</dt>
<dd>
<a href="https://en.wikipedia.org/wiki/George_E._P._Box">George Box</a>
</dd>
</dl>
</blockquote>
<p>Modeling starts with a collection of observations (presence and background for us!) and ends up with a collection of coefficients that can be used with one or more formulas to make a prediction about the past (“hindcast”), the present (“nowcast”) or the future (“forecast”). We are using modeling specifically to make habitat suitability maps for select species under two climate scenarios (RCP45 and RCP85) at two different times (2055 and 2075) in the future.</p>
<p>We can choose from a number of different models: <a href="https://en.wikipedia.org/wiki/Random_forest">random forest “rf”</a>, <a href="https://en.wikipedia.org/wiki/Principle_of_maximum_entropy">maximum entropy “maxent” or “maxnet”</a>, <a href="boosted regression trees">boosted regression trees “brt”</a>, <a href="https://en.wikipedia.org/wiki/General_linear_model">general linear models “glm”</a>, etc. The point of each is to make a mathematical representation of natural occurrences. It is important to consider what those occurrences might be - <em>categorical</em> like labels? <em>likelihoods</em> like probabilities? <em>continuous</em> like measurements? Here are examples of each…</p>
<ul>
<li><strong>Categorical</strong>
<ul>
<li>two class labels: “present/absence”, “red/green”, “shell/no shell”, “alive/dead”</li>
<li>multi-class labels: “vanilla/chocolate/strawberry”, “immature/mature/aged”</li>
</ul></li>
<li><strong>Likelihood and Probability</strong>
<ul>
<li>probability: “50% chance of rain”, “80% chance of a fatal fall”</li>
<li>relativity: “low likelihood of encounter”, “some likelihood of encounter”2199olkm, spired to follow this route by using this <a href="https://oj713.github.io/tidymodels/index.html">tidy models tutorial</a> prepared by our colleague <a href="https://github.com/oj713?tab=repositories">Omi Johnson</a>.</li>
</ul></li>
</ul>
<section id="setup" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Setup</h1>
<p>As always, we start by running our setup function. Start RStudio/R, and reload your project with the menu <code>File &gt; Recent Projects</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"setup.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-data---choose-a-month-and-sampling-approach" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Load data - choose a month and sampling approach</h1>
<p>Let’s load what we need to build a model” the configuration and the complete covariate data. Notice that we (a) transform month to a simple numeric value (it’s easier to work with as a number) and (b) select the covariates that are included in our configuration plus “class”.</p>
<p>You may also catch that we log scale <code>depth</code> and <code>Xbtm</code>. This reduces the numeric range of each to be more comparable to those of the other covariates. This is a common trick when dealing with data that ranges over orders of magnitude compared to companion data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>cfg <span class="ot">=</span> <span class="fu">read_configuration</span>(<span class="at">scientificname =</span> <span class="st">"Mola mola"</span>, <span class="at">version =</span> <span class="st">"v1"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>model_input <span class="ot">=</span> <span class="fu">read_model_input</span>(<span class="at">scientificname =</span> <span class="st">"Mola mola"</span>, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">version =</span> <span class="st">"v1"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">log_me =</span> <span class="fu">c</span>(<span class="st">"depth"</span>, <span class="st">"Xbtm"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">month_as_number</span>(.data<span class="sc">$</span>month)) <span class="sc">|&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"class"</span>, cfg<span class="sc">$</span>keep)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="splitting-the-data-into-groups" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Splitting the data into groups</h1>
<p>Here we want to split the data into two groups: data for training the model during creation and data for testing the model after we have created it. We’ll aim for 80% of the data to train on and reserving 20% of the data for later testing.</p>
<p>After that, we want to split the <strong>training</strong> data so that we have groups, or “folds”, across the spatial domain. This will look approximately like a checkerboard where we (potentially) have a balance of observations and background represented, but it is possible to have strong imbalance in any of the checkerboard squares. That’s OK.</p>
<section id="initial-split-into-training-and-testing-groups" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="initial-split-into-training-and-testing-groups"><span class="header-section-number">3.1</span> Initial split into training and testing groups</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>model_input_split <span class="ot">=</span> <span class="fu">spatial_initial_split</span>(model_input, </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">prop =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">5</span>,     <span class="co"># 20% for testing</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">strategy =</span> spatial_block_cv) <span class="co"># see ?spatial_block_cv</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>model_input_split</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Training/Testing/Total&gt;
&lt;11340/3181/14521&gt;</code></pre>
</div>
</div>
<p>We can see that there are 5 times more points (observations and background) reserved for training. Now we can look at the spatial distribution of the two groups.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(model_input_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="C04_models_files/figure-html/initial_split_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="split-the-training-group-into-regional-folds" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="split-the-training-group-into-regional-folds"><span class="header-section-number">3.2</span> Split the training group into regional folds</h2>
<p>Next we take just the <strong>training</strong> data and split that into a set cross-validation folds. We do this to improve our model by making multiple spatially distributed training mini-datasets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>tr_data <span class="ot">=</span> <span class="fu">training</span>(model_input_split)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>cv_tr_data <span class="ot">&lt;-</span> <span class="fu">spatial_block_cv</span>(tr_data,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">v =</span> <span class="dv">5</span>,     </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cellsize =</span> <span class="fu">grid_cellsize</span>(model_input),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">offset =</span> <span class="fu">grid_offset</span>(model_input) <span class="sc">+</span> <span class="fl">0.00001</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(cv_tr_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="C04_models_files/figure-html/cv_training-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="build-a-recipe" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Build a recipe</h1>
<p>A <code>recipe</code> is a blueprint that guides the data handling and modeling process.</p>
<p>A recipe at a bare minimum needs to know two things: what data it has to work with and what is the relationship among the variables within the data. The latter is expressed as a formula, very similar to how we specify the formula of a line with <code>y = mx + b</code> or a parabola <code>y = ax^2 + bx + c</code>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We often think of formulas as left-hand side (LHS) and right-hand side (RHS) equalities. And usually, the LHS is the outcome while the RHS is about the inputs. For our modeling, the outcome is to predict the across the entire domain. We can generalize the idea with the “is a function of” operator <code>~</code> (the tilde). For the classic formula for a line it like this… <code>y ~ x</code> and a parabola is also <code>y ~ x</code>.</p>
<p>Consider a situation where we have reduced all of the suitable variables to <code>Sbtm</code>, <code>Tbtm</code>, <code>MLD</code> and<code>Xbtm</code>, which we have in a table along with a <code>class</code> variable. In our case we have the outcome is an prediction of <code>class</code> it is a function of variables like <code>Sbtm</code>, <code>Tbtm</code>, <code>MLD</code>, <code>Xbtm</code>, <em>etc.</em> This formula would look like <code>y ~ Sbtm + Tbtm + MLD + Xbtm</code>. Unlike the specific equation for a line or parabola, we don’t pretend to know what coefficients, powers and that sort of stuff looks like. We are just saying that <code>class</code> is a function of all of those variables (somehow).</p>
<p>In the case here where the outcome (<code>class</code>) is a function of all other variables in the table, we have a nice short hand. <code>class ~ .</code> where the dot means “every other variable”.</p>
</div>
</div>
<p>Now we make the recipe. Note that no computation takes place. Technically, <code>recipe()</code> only needs a small subset of the data set to establish the names and data types of the predictor and outcome variables. Just one row would suffice. That underscores that a recipe is simply building a template.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>one_row_of_training_data <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">slice</span>(tr_data,<span class="dv">1</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>rec <span class="ot">=</span> <span class="fu">recipe</span>(one_row_of_training_data, <span class="at">formula =</span> class <span class="sc">~</span> .)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:   1
predictor: 9
coords:    2</code></pre>
</div>
</div>
<p>This print out provides a very high level summary - all of the details are glossed over. To get a more detailed summary use the <code>summary()</code> function. Note that the coordinates (longitude and latitude) are detected and labeled as <code>coords</code> and not predictors. There are ways around that if you need to use longitude or latitude as predictor variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 4
   variable type      role      source  
   &lt;chr&gt;    &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
 1 depth    &lt;chr [2]&gt; predictor original
 2 month    &lt;chr [2]&gt; predictor original
 3 SSS      &lt;chr [2]&gt; predictor original
 4 U        &lt;chr [2]&gt; predictor original
 5 Sbtm     &lt;chr [2]&gt; predictor original
 6 V        &lt;chr [2]&gt; predictor original
 7 Tbtm     &lt;chr [2]&gt; predictor original
 8 MLD      &lt;chr [2]&gt; predictor original
 9 SST      &lt;chr [2]&gt; predictor original
10 X        &lt;chr [2]&gt; coords    original
11 Y        &lt;chr [2]&gt; coords    original
12 class    &lt;chr [3]&gt; outcome   original</code></pre>
</div>
</div>
<p>Each variable in the input is assigned a role: “outcome”, “coords” or “predictor”. The latter are the variables used in the creation of the model. There are other types of roles, (see <code>?recipe</code>) including “case_weight” and “ID”, and others can be defined as needed. Some are used in building the model, others are simply ride along and don’t change the model outcome.</p>
</section>
<section id="create-a-workflow" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Create a workflow</h1>
<p><a href="https://workflows.tidymodels.org/">workflows</a> are containers for storing the pre-processing steps and model specifications. Not too long ago it was quite a challenge to to keep track of all the bits and pieces required to make good forecasts. The advent of <code>workflows</code> greatly simplifies the process. A <code>workflow</code> will house two important items for us: a list if preprocesssor items like recipes and a list of desired models.</p>
<p>We haven’t discussed which kinds of models to use in any detail, so we’ll just pick 4 convenient examples:</p>
<ul>
<li><p>glm: <a href="https://en.wikipedia.org/wiki/Generalized_linear_model">generalized linear model</a></p></li>
<li><p>rf: <a href="https://en.wikipedia.org/wiki/Random_forest">random forest</a></p></li>
<li><p>gbm: <a href="http://download.nust.na/pub3/cran/web/packages/dismo/vignettes/brt.pdf">boosted regression trees</a></p></li>
<li><p>maxent: <a href="https://en.wikipedia.org/wiki/Principle_of_maximum_entropy">maximum entropy</a></p></li>
</ul>
<p>It is here that we specify the hyperparameters to tune. In general we accept the defaults, but for <code>random_forest</code> we ask that we include tuning on the number of trees, too.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>wflow <span class="ot">=</span> <span class="fu">workflow_set</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">preproc =</span> <span class="fu">list</span>(<span class="at">default =</span> rec), <span class="co"># not much happening in our preprocessor</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">list</span>(                 <span class="co"># but we have 4 models to add</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># very simple - nothing to tune</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">glm =</span> <span class="fu">logistic_reg</span>(</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">mode =</span> <span class="st">"classification"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_engine</span>(<span class="st">"glm"</span>),</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># two knobs to tune</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">rf =</span> <span class="fu">rand_forest</span>(</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">mode =</span> <span class="st">"classification"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>                   <span class="at">importance =</span> <span class="st">"impurity"</span>),</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>      <span class="co"># so many things to tune!</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">btree =</span> <span class="fu">boost_tree</span>(</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">mtry =</span> <span class="fu">tune</span>(), </span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">trees =</span> <span class="fu">tune</span>(), </span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">tree_depth =</span> <span class="fu">tune</span>(), </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>          <span class="at">learn_rate =</span> <span class="fu">tune</span>(), </span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>          <span class="at">loss_reduction =</span> <span class="fu">tune</span>(), </span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>          <span class="at">stop_iter =</span> <span class="fu">tune</span>(),</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>          <span class="at">mode =</span> <span class="st">"classification"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>),</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>      <span class="co"># just two again</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">maxent =</span> <span class="fu">maxent</span>(</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>          <span class="at">feature_classes =</span> <span class="fu">tune</span>(),</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>          <span class="at">regularization_multiplier =</span> <span class="fu">tune</span>(),</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>          <span class="at">mode =</span> <span class="st">"classification"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_engine</span>(<span class="st">"maxnet"</span>)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>wflow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A workflow set/tibble: 4 × 4
  wflow_id       info             option    result    
  &lt;chr&gt;          &lt;list&gt;           &lt;list&gt;    &lt;list&gt;    
1 default_glm    &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
2 default_rf     &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
3 default_btree  &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
4 default_maxent &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;</code></pre>
</div>
</div>
<p>That’s it! Of course, it’s just a container of our goodies. Really, it has not done anything other than a few checks.</p>
<section id="chosing-metrics-for-measuring-how-well-the-models-do" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="chosing-metrics-for-measuring-how-well-the-models-do"><span class="header-section-number">5.1</span> Chosing metrics for measuring how well the models do</h2>
<p>We next chose which metrics to use when evaluating model performance. The authors of the <a href="https://evolecolgroup.github.io/tidysdm/">tidysdm R package</a> have a preferred set: <a href="https://evolecolgroup.github.io/tidysdm/reference/boyce_cont.html">Boyce Continuous Index</a>, <a href="https://evolecolgroup.github.io/tidysdm/reference/tss_max.html">True Skill Statistic</a> and <a href="https://evolecolgroup.github.io/tidysdm/reference/prob_metrics_sf.html">Area Under the Receiver Operator Curve</a>. There are many others we could opt for in addition to these (or to replace these.) To the default set we’ll add <a href="https://cran.r-project.org/web/packages/yardstick/vignettes/metric-types.html">accuracy</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">=</span> <span class="fu">sdm_metric_set</span>(yardstick<span class="sc">::</span>accuracy)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A metric set, consisting of:
- `boyce_cont()`, a probability metric | direction: maximize
- `roc_auc()`, a probability metric    | direction: maximize
- `tss_max()`, a probability metric    | direction: maximize
- `accuracy()`, a class metric         | direction: maximize</code></pre>
</div>
</div>
<p>These are analogous to a chef preparing a meal and deciding what tools might be necessary to test what is in the oven: “I’ll need a thermometer, a toothpick and maybe a turning fork”.</p>
</section>
</section>
<section id="fit-the-models-to-the-various-recipes" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Fit the models to the various recipes</h1>
<p>But first…</p>
<section id="hyperparameters---say-what" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="hyperparameters---say-what"><span class="header-section-number">6.1</span> Hyperparameters? - say what?</h2>
<blockquote class="blockquote">
<p>Many models have <strong>hyperparameters</strong> that can’t be learned directly from a single data set when training the model. Instead, we can train many models in a grid of possible hyperparameter values and see which ones turn out best. <a href="https://www.tidymodels.org/learn/work/tune-svm/">from Tidy Models with R</a></p>
</blockquote>
<p>So they are parameters (knobs) set for each model. These parameters help guide the optimal structure for solving the problem. Think of an music conductor planning for a concert: what is the right hall for this performance? How many cellos do we need? Do I have to have a kettle drum? These are structural questions before diving into the actual music to be played.</p>
<p>In order to figure out the best values to set these parameters to we actually vary them while running the model in “mini-mode” repeatedly and then picking the “best”. For each iteration we provide a small portion of the data, and we test various values that the parameters might take on.</p>
<section id="iterate-to-find-various-hyperparameter-sets" class="level3" data-number="6.1.1">
<h3 data-number="6.1.1" class="anchored" data-anchor-id="iterate-to-find-various-hyperparameter-sets"><span class="header-section-number">6.1.1</span> Iterate to find various hyperparameter sets</h3>
<p>Next, we will deploy a function that will take each recipe-model combination and iterator over each of the many-many-many folds (well, 5 in our case) while adjusting the parameters (if any can be adjusted). The results of each iteration will be tracked so we can get a sense of the range and average. And then we’ll run each of those iterations three times and come up with an average for each. Imagine that this is like a team of minions, each armed with a recipe and model, directing other minions to run the model fitting on each fold. We are only setting up a grid of 3, which is fine for our class but in practice might be a much higher number. A systematic and exhaustive “grid” approach works well for small cases, but it can become unwieldy. Other approaches include random sampling and other techniques to lower the computational burden. Depending upon the number of models and how many hyperparamters there are this step can take a while.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>wflow <span class="ot">&lt;-</span> wflow <span class="sc">|&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(<span class="st">"tune_grid"</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> cv_tr_data, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="dv">3</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> metrics, </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>i   No tuning parameters. `fit_resamples()` will be attempted</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i 1 of 4 resampling: default_glm</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 1 of 4 resampling: default_glm (956ms)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i 2 of 4 tuning:     default_rf</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Creating pre-processing data to finalize unknown parameter: mtry</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 2 of 4 tuning:     default_rf (8m 44.7s)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i 3 of 4 tuning:     default_btree</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Creating pre-processing data to finalize unknown parameter: mtry</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ A | warning: Passed invalid argument 'info' - entries on it should be passed as direct arguments. This warning will become an error in a future version., Passed invalid function arguments: nthread. These should be passed as a list to argument 'params'. Conversion from argument to 'params' entry will be done automatically, but this behavior will become an error in a future version., Parameter 'watchlist' has been renamed to 'evals'. This warning will become an error in a future version., Argument 'objective' is only for custom objectives. For built-in objectives, pass the objective under 'params'. This warning will become an error in a future version.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>There were issues with some computations   A: x1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>There were issues with some computations   A: x2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>There were issues with some computations   A: x3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>There were issues with some computations   A: x6</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>There were issues with some computations   A: x7</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>There were issues with some computations   A: x9</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>There were issues with some computations   A: x12</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>There were issues with some computations   A: x13</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>There were issues with some computations   A: x15
There were issues with some computations   A: x15</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 3 of 4 tuning:     default_btree (1m 10.3s)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i 4 of 4 tuning:     default_maxent</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 4 of 4 tuning:     default_maxent (1m 10.6s)</code></pre>
</div>
</div>
<p>Here’s a quick plot of the outputs, with each metric being showcased.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(wflow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="C04_models_files/figure-html/plot_wflow-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note that “default_glm” (here listed as “logistic_reg”) only has one result rather than three. That is because there are no hyperparameters to tune in general linearized models.</p>
</section>
<section id="choose-the-best-set-of-hyperparameters-for-each-model" class="level3" data-number="6.1.2">
<h3 data-number="6.1.2" class="anchored" data-anchor-id="choose-the-best-set-of-hyperparameters-for-each-model"><span class="header-section-number">6.1.2</span> Choose the best set of hyperparameters for each model</h3>
<p>What is the best configuration of hyperparameters for each model? Well, for “default_glm” there is only one, so that sort of doesn’t count - we chose the only one we have. For the others we have to dig in to figure out which set of hyperparameters is best for each model. We have written a wrapper function to speed things along; it accepts the workflow set, the full split data object and the path and filename to save the models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>model_fits <span class="ot">=</span> <span class="fu">workflowset_selectomatic</span>(wflow, model_input_split,</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">filename =</span> <span class="st">"Mola_mola-v1-model_fits"</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">path =</span> <span class="fu">data_path</span>(<span class="st">"models"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>→ A | warning: Passed invalid argument 'info' - entries on it should be passed as direct arguments. This warning will become an error in a future version., Passed invalid function arguments: nthread. These should be passed as a list to argument 'params'. Conversion from argument to 'params' entry will be done automatically, but this behavior will become an error in a future version., Parameter 'watchlist' has been renamed to 'evals'. This warning will become an error in a future version., Argument 'objective' is only for custom objectives. For built-in objectives, pass the objective under 'params'. This warning will become an error in a future version.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>There were issues with some computations   A: x1
There were issues with some computations   A: x1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>model_fits</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 7
  wflow_id  splits               id    .metrics .notes   .predictions .workflow 
  &lt;chr&gt;     &lt;list&gt;               &lt;chr&gt; &lt;list&gt;   &lt;list&gt;   &lt;list&gt;       &lt;list&gt;    
1 default_… &lt;split [11340/3181]&gt; trai… &lt;tibble&gt; &lt;tibble&gt; &lt;tibble&gt;     &lt;workflow&gt;
2 default_… &lt;split [11340/3181]&gt; trai… &lt;tibble&gt; &lt;tibble&gt; &lt;tibble&gt;     &lt;workflow&gt;
3 default_… &lt;split [11340/3181]&gt; trai… &lt;tibble&gt; &lt;tibble&gt; &lt;tibble&gt;     &lt;workflow&gt;
4 default_… &lt;split [11340/3181]&gt; trai… &lt;tibble&gt; &lt;tibble&gt; &lt;tibble&gt;     &lt;workflow&gt;</code></pre>
</div>
</div>
<p>So we get back 4 models (that’s good). Let’s look at the random forest and pick out the <code>.metrics</code>, <code>.predictions</code> and <code>.workflow</code> columns. Note that the leading <code>.</code> is simply there to let you you that these parts were derived in the <code>selectomatic</code> function.</p>
</section>
</section>
<section id="exploring-the-collection-of-model-fit-results" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="exploring-the-collection-of-model-fit-results"><span class="header-section-number">6.2</span> Exploring the collection of model fit results</h2>
<p>We can make simple collective representations of the fitted models.</p>
<section id="a-table-of-metrics" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="a-table-of-metrics"><span class="header-section-number">6.2.1</span> A table of metrics</h3>
<p>We can quickly pull together summary statistics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">model_fit_metrics</span>(model_fits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  wflow_id       accuracy boyce_cont roc_auc tss_max
  &lt;chr&gt;             &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 default_glm       0.729      0.929   0.804   0.552
2 default_rf        0.733      0.921   0.813   0.545
3 default_btree     0.746      0.845   0.822   0.564
4 default_maxent    0.726      0.910   0.821   0.551</code></pre>
</div>
</div>
</section>
<section id="confusion-matrices-and-accuracy" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="confusion-matrices-and-accuracy"><span class="header-section-number">6.2.2</span> Confusion matrices and accuracy</h3>
<p>We can plot confusion matrices and add accuracy. Accuracy is the proportion of the data that are predicted correctly. Of course, we would love to see each of these models achieve perfect accuracy, but that is the nature of modeling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">model_fit_confmat</span>(model_fits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="C04_models_files/figure-html/model_fit_confmat-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="rocauc" class="level3" data-number="6.2.3">
<h3 data-number="6.2.3" class="anchored" data-anchor-id="rocauc"><span class="header-section-number">6.2.3</span> ROC/AUC</h3>
<p>We can collate plots of Receiver Operator Curves (ROC) from which the Area Under the Curve (AUC) is computed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">model_fit_roc_auc</span>(model_fits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="C04_models_files/figure-html/model_fit_roc_auc-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="variable-importance" class="level3" data-number="6.2.4">
<h3 data-number="6.2.4" class="anchored" data-anchor-id="variable-importance"><span class="header-section-number">6.2.4</span> Variable importance</h3>
<p>Variable importance can tell us about the contribution each covariate variable makes toward the whole. It doesn’t compare between models, just within a given model. Reading the heatmap below scans a given model’s row. For instance, <code>MLD</code> and <code>SST</code> seem to have equally high importance for <code>default_rf</code> (random forest) compared to the other covariates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">model_fit_vip</span>(model_fits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="C04_models_files/figure-html/model_fit_vip-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="exploring-a-single-model-fit-result" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="exploring-a-single-model-fit-result"><span class="header-section-number">6.3</span> Exploring a single model fit result</h2>
<p>Let’s pull out one of the model fits and look at it’s parts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>rf <span class="ot">=</span> model_fits <span class="sc">|&gt;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(wflow_id <span class="sc">==</span> <span class="st">"default_rf"</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
  wflow_id  splits               id    .metrics .notes   .predictions .workflow 
  &lt;chr&gt;     &lt;list&gt;               &lt;chr&gt; &lt;list&gt;   &lt;list&gt;   &lt;list&gt;       &lt;list&gt;    
1 default_… &lt;split [11340/3181]&gt; trai… &lt;tibble&gt; &lt;tibble&gt; &lt;tibble&gt;     &lt;workflow&gt;</code></pre>
</div>
</div>
<section id="splits" class="level4" data-number="6.3.0.1">
<h4 data-number="6.3.0.1" class="anchored" data-anchor-id="splits"><span class="header-section-number">6.3.0.1</span> <code>splits</code></h4>
<p>These are the allocations of training and testing elements in the original dataset. We can see it looks like the same distribution as our initial split (above).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rf<span class="sc">$</span>splits[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="C04_models_files/figure-html/rf_splits-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="metrics" class="level4" data-number="6.3.0.2">
<h4 data-number="6.3.0.2" class="anchored" data-anchor-id="metrics"><span class="header-section-number">6.3.0.2</span> <code>.metrics</code></h4>
<p>These are simply the metrics associated with the best set of hyperparameters. We can see the aggregate of the “pre-selection” metrics in the metrics plot earlier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>rf<span class="sc">$</span>.metrics[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
  .metric    .estimator .estimate .config             
  &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 accuracy   binary         0.733 Preprocessor1_Model1
2 boyce_cont binary         0.921 Preprocessor1_Model1
3 roc_auc    binary         0.813 Preprocessor1_Model1
4 tss_max    binary         0.545 Preprocessor1_Model1</code></pre>
</div>
</div>
</section>
<section id="predictions" class="level4" data-number="6.3.0.3">
<h4 data-number="6.3.0.3" class="anchored" data-anchor-id="predictions"><span class="header-section-number">6.3.0.3</span> <code>.predictions</code></h4>
<p>Here we can see the <strong>testing</strong> data predictions. Ultimately we are interested in <code>.pred_class</code> and <code>class</code>, but there’s a lot of data to explore in here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>rf<span class="sc">$</span>.predictions[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,181 × 6
   .pred_presence .pred_background  .row .pred_class class      .config         
            &lt;dbl&gt;            &lt;dbl&gt; &lt;int&gt; &lt;fct&gt;       &lt;fct&gt;      &lt;chr&gt;           
 1          0.161            0.839     2 background  presence   Preprocessor1_M…
 2          0                1         3 background  presence   Preprocessor1_M…
 3          0                1         4 background  presence   Preprocessor1_M…
 4          0                1         7 background  background Preprocessor1_M…
 5          0                1        12 background  background Preprocessor1_M…
 6          0                1        15 background  background Preprocessor1_M…
 7          0                1        22 background  background Preprocessor1_M…
 8          0                1        24 background  background Preprocessor1_M…
 9          0                1        26 background  background Preprocessor1_M…
10          0                1        27 background  background Preprocessor1_M…
# ℹ 3,171 more rows</code></pre>
</div>
</div>
</section>
<section id="workflow" class="level4" data-number="6.3.0.4">
<h4 data-number="6.3.0.4" class="anchored" data-anchor-id="workflow"><span class="header-section-number">6.3.0.4</span> <code>.workflow</code></h4>
<p>The workflow is the encapsulation of the model formula form the recipe, the tuned hyperparameters and well as any fitting coefficients for the mode. When we print it we get a summary statement about the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>rf<span class="sc">$</span>.workflow[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: rand_forest()

── Preprocessor ────────────────────────────────────────────────────────────────
0 Recipe Steps

── Model ───────────────────────────────────────────────────────────────────────
Ranger result

Call:
 ranger::ranger(x = maybe_data_frame(x), y = y, mtry = min_cols(~6L,      x), num.trees = ~56L, importance = ~"impurity", num.threads = 1,      verbose = FALSE, seed = sample.int(10^5, 1), probability = TRUE) 

Type:                             Probability estimation 
Number of trees:                  56 
Sample size:                      11340 
Number of independent variables:  9 
Mtry:                             6 
Target node size:                 10 
Variable importance mode:         impurity 
Splitrule:                        gini 
OOB prediction error (Brier s.):  0.2342822 </code></pre>
</div>
</div>
</section>
<section id="partial-dependence-plot" class="level3" data-number="6.3.1">
<h3 data-number="6.3.1" class="anchored" data-anchor-id="partial-dependence-plot"><span class="header-section-number">6.3.1</span> Partial dependence plot</h3>
<p>Partial dependence reflects the relative contribution of each variable influence over it’s full range of values. The output is a grid grid of plots showing the relative distribution of the variable (bars) as well as the relative influence of the variable (line).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">model_fit_pdp</span>(model_fits, <span class="at">wid =</span> <span class="st">"default_btree"</span>, <span class="at">title =</span> <span class="st">"Boosted Tree"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="C04_models_files/figure-html/pd_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="recap" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Recap</h1>
<p>We have built 4 types of models using tools from the <a href="https://www.tidymodels.org/">tidymodels universe</a>. After reading in a suite of data, we split our data into training and testing sets, withholding the testing set until the very end. We looked a variety of metrics including a confusion matrix, ROC and AUC, accuracy and partial dependencies. We saved the recipe and model together in a special container, called a workflow set, to a file.</p>
</section>
<section id="coding-assignment" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Coding Assignment</h1>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./C03_covariates.html" class="pagination-link" aria-label="Covariates">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Covariates</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./C05_prediction.html" class="pagination-link" aria-label="Prediction">
        <span class="nav-page-text">Prediction</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2025, Bigelow Laboratory for Ocean Science</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>